{% extends 'base.html' %}

{% block title %}Reportes | Aurora HR{% endblock %}
{% block header_title %}Análisis de Anomalías y Productividad{% endblock %}

{% block content %}
<div class="mb-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        
        <form method="get" class="flex items-end gap-2">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Seleccionar día de la semana</label>
                <input type="date" name="fecha" value="{{ fecha|date:'Y-m-d' }}" class="border border-slate-300 p-2 rounded-lg text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">
                <i class="fa-solid fa-filter mr-2"></i> Analizar Semana
            </button>
        </form>

        <div class="text-right">
            <p class="text-xs font-bold text-slate-400 uppercase">Reporte Semanal</p>
            <h2 class="text-xl font-bold text-slate-800">
                Del {{ inicio_semana|date:"d M" }} al {{ fin_semana|date:"d M, Y" }}
            </h2>
            <p class="text-sm text-blue-600 font-medium mt-1">
                {{ creadas }} anomalías detectadas
            </p>
        </div>
    </div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-red-50 border border-red-100 p-6 rounded-xl flex items-center justify-between">
        <div>
            <p class="text-red-600 font-bold uppercase text-xs">Horas Hombre Perdidas</p>
            <h3 class="text-4xl font-bold text-red-700">{{ horas_perdidas }} h</h3>
            <p class="text-xs text-red-400 mt-1">Equivalente en jornada laboral</p>
        </div>
        <div class="bg-white p-3 rounded-full text-red-500 shadow-sm"><i class="fa-solid fa-clock text-2xl"></i></div>
    </div>
    
    <div class="bg-orange-50 border border-orange-100 p-6 rounded-xl flex items-center justify-between">
        <div>
            <p class="text-orange-600 font-bold uppercase text-xs">Costo Estimado (Día)</p>
            <h3 class="text-4xl font-bold text-orange-700">$ {{ dinero_perdido }}</h3>
            <p class="text-xs text-orange-400 mt-1">Basado en valor hora promedio</p>
        </div>
        <div class="bg-white p-3 rounded-full text-orange-500 shadow-sm"><i class="fa-solid fa-sack-dollar text-2xl"></i></div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h3 class="font-bold text-slate-700 mb-4">Distribución de Faltas</h3>
        <div class="h-64">
            <canvas id="chartTipos"></canvas>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <h3 class="font-bold text-slate-700 mb-4">Áreas con Mayor Pérdida (Minutos)</h3>
        <div class="h-64">
            <canvas id="chartAreas"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // PREPARAR DATOS DESDE DJANGO
    const dataTipos = {{ datos_tipo|safe }};
    const dataAreas = {{ datos_area|safe }};

    // 1. Gráfico de Torta (Tipos)
    new Chart(document.getElementById('chartTipos'), {
        type: 'doughnut',
        data: {
            labels: dataTipos.map(d => d.tipo),
            datasets: [{
                data: dataTipos.map(d => d.total),
                backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#6366f1']
            }]
        },
        options: { maintainAspectRatio: false }
    });

    // 2. Gráfico de Barras (Áreas)
    new Chart(document.getElementById('chartAreas'), {
        type: 'bar',
        data: {
            labels: dataAreas.map(d => d.colaborador__area || 'Sin Área'),
            datasets: [{
                label: 'Minutos Perdidos',
                data: dataAreas.map(d => d.minutos),
                backgroundColor: '#1e3a8a',
                borderRadius: 4
            }]
        },
        options: { 
            maintainAspectRatio: false,
            indexAxis: 'y', // Barra horizontal para leer mejor los nombres
            scales: { x: { beginAtZero: true } }
        }
    });
</script>
{% endblock %}
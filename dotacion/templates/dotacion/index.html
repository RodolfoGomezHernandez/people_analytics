{% extends 'core/base.html' %}

{% block title %}Dotaci贸n | Aurora HR{% endblock %}
{% block header_title %}Dotaci贸n{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!--  KPIs  -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">Dotaci贸n Vigente</p>
        <p class="text-3xl font-bold text-gray-800">{{ kpi_vigentes }}</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-slate-400">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">Hist贸rico Total</p>
        <p class="text-3xl font-bold text-gray-800">{{ kpi_historico }}</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-400">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">Datos Faltantes</p>
        <p class="text-3xl font-bold text-gray-800">{{ kpi_sin_contacto }}</p>
        <p class="text-xs text-yellow-600 mt-1">Sin email o tel茅fono</p>
    </div>

    <button onclick="document.getElementById('uploadSection').classList.toggle('hidden')"
        class="bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-sm p-6 text-white flex items-center justify-between transition cursor-pointer">
        <div>
            <p class="font-bold text-sm"> Cargar Fichas</p>
            <p class="text-xs mt-1 opacity-80">Reporte GREX (.xlsx)</p>
        </div>
        <i class="fa-solid fa-chevron-down"></i>
    </button>
</div>

<!--  Formulario de carga  -->
<div id="uploadSection" class="hidden bg-white rounded-xl shadow-sm border border-indigo-100 mb-8">
    <div class="p-6">
        <h3 class="font-bold text-slate-700 mb-1">Actualizar Dotaci贸n</h3>
        <p class="text-xs text-slate-400 mb-4">
            Exporta el <strong>Reporte de Fichas</strong> desde GREX y c谩rgalo aqu铆.
            El sistema actualizar谩 colaboradores existentes y crear谩 nuevos.
        </p>
        <form method="post" enctype="multipart/form-data" class="flex flex-col sm:flex-row gap-4 items-end">
            {% csrf_token %}
            <div class="flex-1">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Archivo Excel</label>
                {{ form.archivo }}
                {% if form.archivo.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.archivo.errors.0 }}</p>
                {% endif %}
            </div>
            <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-bold transition shadow-sm whitespace-nowrap">
                <i class="fa-solid fa-upload mr-2"></i>Procesar
            </button>
        </form>
    </div>
</div>

{% if kpi_vigentes > 0 %}
<!--  Gr谩ficos  -->
<!--  Gr谩ficos temporales  -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">
                Dotaci贸n Activa por Semana
            </h3>
            <button onclick="descargarChart('chartDotacion', 'dotacion_semanal')"
                class="text-xs text-slate-400 hover:text-indigo-600 transition flex items-center gap-1">
                <i class="fa-solid fa-download"></i> PNG
            </button>
        </div>
        <div class="h-64 relative"><canvas id="chartDotacion"></canvas></div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">
                Contrataciones por Semana
            </h3>
            <button onclick="descargarChart('chartContrataciones', 'contrataciones_semana')"
                class="text-xs text-slate-400 hover:text-indigo-600 transition flex items-center gap-1">
                <i class="fa-solid fa-download"></i> PNG
            </button>
        </div>
        <div class="h-64 relative"><canvas id="chartContrataciones"></canvas></div>
    </div>
</div>

<!--  Gr谩ficos demogr谩ficos  -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">

    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Distribuci贸n por G茅nero</h3>
            <button onclick="descargarChart('chartSexo', 'genero')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <canvas id="chartSexo" height="220"></canvas>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Rango Etario</h3>
            <button onclick="descargarChart('chartEdad', 'rango_etario')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <canvas id="chartEdad" height="220"></canvas>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Top Nacionalidades</h3>
            <button onclick="descargarChart('chartNacionalidad', 'nacionalidades')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <canvas id="chartNacionalidad" height="220"></canvas>
    </div>
</div>

<div class="bg-white p-6 rounded-xl shadow-sm mb-8">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Distribuci贸n por Comuna</h3>
        <button onclick="descargarChart('chartComuna', 'comunas')" class="text-xs text-slate-400 hover:text-indigo-600 transition flex items-center gap-1"><i class="fa-solid fa-download"></i> PNG</button>
    </div>
    <div class="h-64">
        <canvas id="chartComuna"></canvas>
    </div>
</div>

<script>
//  Utilidad descarga 
function descargarChart(canvasId, nombre) {
    const link = document.createElement('a');
    link.download = `${nombre}_${new Date().toISOString().slice(0,10)}.png`;
    link.href = document.getElementById(canvasId).toDataURL('image/png');
    link.click();
}

    //  Dotaci贸n activa semanal 
    new Chart(document.getElementById('chartDotacion'), {
        type: 'line',
        data: {
            labels: {{ chart_dotacion_labels|safe }},
            datasets: [{
                label: 'Personas activas',
                data: {{ chart_dotacion_values|safe }},
                borderColor: '#6366F1',
                backgroundColor: 'rgba(99,102,241,0.08)',
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { maxTicksLimit: 12, font: { size: 10 } }, grid: { display: false } },
                y: { beginAtZero: false, ticks: { font: { size: 10 } } }
            }
        }
    });

    //  Contrataciones por semana 
    new Chart(document.getElementById('chartContrataciones'), {
        type: 'bar',
        data: {
            labels: {{ chart_contrataciones_labels|safe }},
            datasets: [{
                label: 'Nuevas contrataciones',
                data: {{ chart_contrataciones_values|safe }},
                backgroundColor: '#10B981',
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { maxTicksLimit: 12, font: { size: 10 } }, grid: { display: false } },
                y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 10 } } }
            }
        }
    });

    //  G茅nero 
    new Chart(document.getElementById('chartSexo'), {
        type: 'doughnut',
        data: {
            labels: {{ chart_sexo_labels|safe }},
            datasets: [{ data: {{ chart_sexo_values|safe }},
                backgroundColor: ['#3B82F6', '#EC4899', '#10B981', '#F59E0B'] }]
        },
        options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
    });

    //  Edad 
    new Chart(document.getElementById('chartEdad'), {
        type: 'bar',
        data: {
            labels: {{ chart_edad_labels|safe }},
            datasets: [{ label: 'Colaboradores', data: {{ chart_edad_values|safe }},
                backgroundColor: '#8B5CF6', borderRadius: 4 }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    //  Nacionalidad 
    new Chart(document.getElementById('chartNacionalidad'), {
        type: 'pie',
        data: {
            labels: {{ chart_nacionalidad_labels|safe }},
            datasets: [{ data: {{ chart_nacionalidad_values|safe }},
                backgroundColor: ['#F59E0B','#EF4444','#10B981','#6366F1','#6B7280','#3B82F6'] }]
        },
        options: { plugins: { legend: { position: 'bottom' } }, responsive: true }
    });

    //  Comunas 
    new Chart(document.getElementById('chartComuna'), {
        type: 'bar',
        data: {
            labels: {{ chart_comuna_labels|safe }},
            datasets: [{ label: 'Residencia', data: {{ chart_comuna_values|safe }},
                backgroundColor: '#10B981', borderRadius: 4 }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
</script>

{% else %}
<div class="bg-white rounded-xl shadow-sm border border-dashed border-slate-300 p-16 text-center">
    <i class="fa-solid fa-users text-4xl text-slate-300 mb-4"></i>
    <p class="text-slate-500 font-medium">No hay colaboradores cargados a煤n.</p>
    <p class="text-slate-400 text-sm mt-1">Usa el bot贸n <strong>"Cargar Fichas"</strong> para importar el primer reporte.</p>
</div>
{% endif %}

{% endblock %}
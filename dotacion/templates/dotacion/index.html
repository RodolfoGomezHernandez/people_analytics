{% extends 'core/base.html' %}

{% block title %}DotaciÃ³n | Aurora HR{% endblock %}
{% block header_title %}DotaciÃ³n{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">DotaciÃ³n Vigente</p>
        <p class="text-3xl font-bold text-gray-800" id="kpiVigentes">â€”</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-slate-400">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">HistÃ³rico Total</p>
        <p class="text-3xl font-bold text-gray-800" id="kpiHistorico">â€”</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-400">
        <p class="text-gray-500 text-xs uppercase font-bold mb-1">Datos Faltantes</p>
        <p class="text-3xl font-bold text-gray-800" id="kpiSinContacto">â€”</p>
        <p class="text-xs text-yellow-600 mt-1">Sin email o telÃ©fono</p>
    </div>

    <button onclick="document.getElementById('uploadSection').classList.toggle('hidden')"
        class="bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-sm p-6 text-white flex items-center justify-between transition cursor-pointer">
        <div>
            <p class="font-bold text-sm">ðŸ“¤ Cargar Fichas</p>
            <p class="text-xs mt-1 opacity-80">Reporte GREX (.xlsx)</p>
        </div>
        <i class="fa-solid fa-chevron-down"></i>
    </button>
</div>

<!-- â”€â”€ Formulario de carga â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="uploadSection" class="hidden bg-white rounded-xl shadow-sm border border-indigo-100 mb-6">
    <div class="p-6">
        <h3 class="font-bold text-slate-700 mb-1">Actualizar DotaciÃ³n</h3>
        <p class="text-xs text-slate-400 mb-4">
            Exporta el <strong>Reporte de Fichas</strong> desde GREX y cÃ¡rgalo aquÃ­.
            El sistema actualizarÃ¡ colaboradores existentes y crearÃ¡ nuevos.
        </p>
        <form method="post" enctype="multipart/form-data" class="flex flex-col sm:flex-row gap-4 items-end">
            {% csrf_token %}
            <div class="flex-1">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Archivo Excel</label>
                {{ form.archivo }}
                {% if form.archivo.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.archivo.errors.0 }}</p>
                {% endif %}
            </div>
            <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-bold transition shadow-sm whitespace-nowrap">
                <i class="fa-solid fa-upload mr-2"></i>Procesar
            </button>
        </form>
    </div>
</div>

<!-- â”€â”€ Filtro de fechas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 mb-6">
    <div class="flex flex-col sm:flex-row gap-4 items-end">
        <div>
            <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Fecha Inicio</label>
            <input type="date" id="fechaInicio" value="{{ fecha_inicio_default }}"
                class="p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
        </div>
        <div>
            <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Fecha Fin</label>
            <input type="date" id="fechaFin" value="{{ fecha_fin_default }}"
                class="p-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
        </div>
        <button onclick="cargarDatos()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold transition text-sm flex items-center gap-2">
            <i class="fa-solid fa-filter"></i> Filtrar
        </button>
        <span id="loadingIndicator" class="hidden text-xs text-slate-400 flex items-center gap-1">
            <i class="fa-solid fa-spinner fa-spin"></i> Cargando...
        </span>
    </div>
</div>

<!-- â”€â”€ GrÃ¡ficos temporales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">DotaciÃ³n Activa por Semana</h3>
            <button onclick="descargarChart('chartDotacion', 'dotacion_semanal')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i> PNG</button>
        </div>
        <div class="h-64 relative"><canvas id="chartDotacion"></canvas></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Contrataciones por Semana</h3>
            <button onclick="descargarChart('chartContrataciones', 'contrataciones_semana')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i> PNG</button>
        </div>
        <div class="h-64 relative"><canvas id="chartContrataciones"></canvas></div>
    </div>
</div>

<!-- â”€â”€ GrÃ¡ficos demogrÃ¡ficos fila 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">DistribuciÃ³n por GÃ©nero</h3>
            <button onclick="descargarChart('chartSexo', 'genero')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-52 relative"><canvas id="chartSexo"></canvas></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Rango Etario</h3>
            <button onclick="descargarChart('chartEdad', 'rango_etario')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-52 relative"><canvas id="chartEdad"></canvas></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Nivel Educacional</h3>
            <button onclick="descargarChart('chartEscolaridad', 'nivel_educacional')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-52 relative"><canvas id="chartEscolaridad"></canvas></div>
    </div>
</div>

<!-- â”€â”€ GrÃ¡ficos demogrÃ¡ficos fila 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Nacionalidades</h3>
            <button onclick="descargarChart('chartNacionalidad', 'nacionalidades')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-64 relative"><canvas id="chartNacionalidad"></canvas></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Permanencia</h3>
            <button onclick="descargarChart('chartPermanencia', 'permanencia')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-64 relative"><canvas id="chartPermanencia"></canvas></div>
    </div>
</div>

<!-- â”€â”€ GrÃ¡ficos demogrÃ¡ficos fila 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Sectores (Comunas de Residencia)</h3>
            <button onclick="descargarChart('chartComuna', 'comunas')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-72 relative"><canvas id="chartComuna"></canvas></div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-slate-600 font-bold text-xs uppercase tracking-wider">Personal de Planta (Tipo Contrato)</h3>
            <button onclick="descargarChart('chartTipoContrato', 'tipo_contrato')" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-download"></i></button>
        </div>
        <div class="h-72 relative"><canvas id="chartTipoContrato"></canvas></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
Chart.register(ChartDataLabels);

const API_URL = "{% url 'dotacion_api_kpis' %}";
const charts  = {};

const COLORES = [
    '#6366F1','#10B981','#F59E0B','#EF4444','#3B82F6',
    '#EC4899','#8B5CF6','#14B8A6','#F97316','#6B7280'
];

// â”€â”€ Descarga PNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function descargarChart(id, nombre) {
    const a = document.createElement('a');
    a.download = `${nombre}_${new Date().toISOString().slice(0,10)}.png`;
    a.href = document.getElementById(id).toDataURL('image/png');
    a.click();
}

// â”€â”€ Crear / actualizar chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function upsertChart(id, type, labels, values, label, options = {}) {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) charts[id].destroy();

    const isMultiColor = ['doughnut', 'pie'].includes(type);
    const color = options.color || '#6366F1';

    // â”€â”€ ConfiguraciÃ³n de datalabels segÃºn tipo â”€â”€â”€â”€â”€â”€â”€
    let datalabelsConfig = { display: false }; // por defecto oculto

    if (type === 'doughnut' || type === 'pie') {
        datalabelsConfig = {
            display: true,
            color: '#fff',
            font: { weight: 'bold', size: 11 },
            formatter: (val, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const pct   = ((val / total) * 100).toFixed(1);
                return pct >= 5 ? `${val}\n(${pct}%)` : ''; // oculta slices muy pequeÃ±os
            },
            textAlign: 'center',
        };
    } else if (type === 'bar' && options.horizontal) {
        datalabelsConfig = {
            display: true,
            anchor: 'end',
            align: 'right',
            offset: 4,
            color: '#334155',
            font: { weight: 'bold', size: 10 },
            formatter: val => val > 0 ? val : '',
        };
    } else if (type === 'bar') {
        datalabelsConfig = {
            display: true,
            anchor: 'end',
            align: 'top',
            offset: 2,
            color: '#334155',
            font: { weight: 'bold', size: 10 },
            formatter: val => val > 0 ? val : '',
        };
    } else if (type === 'line') {
        datalabelsConfig = {
            display: 'auto',        // solo muestra si hay espacio
            anchor: 'top',
            align: 'top',
            offset: 4,
            color: options.color || '#6366F1',
            font: { weight: 'bold', size: 9 },
            formatter: val => val > 0 ? val : '',
        };
    }

    charts[id] = new Chart(ctx, {
        type,
        data: {
            labels,
            datasets: [{
                label,
                data            : values,
                backgroundColor : isMultiColor ? COLORES : (options.fill ? color + '20' : color),
                borderColor     : isMultiColor ? undefined : color,
                fill            : options.fill || false,
                tension         : 0.4,
                borderRadius    : type === 'bar' ? 4 : undefined,
                pointRadius     : type === 'line' ? 2 : undefined,
            }]
        },
        options: {
            responsive          : true,
            maintainAspectRatio : false,
            indexAxis           : options.horizontal ? 'y' : 'x',
            layout: {
                // Espacio extra para que los labels no se corten
                padding: {
                    top   : type === 'bar' && !options.horizontal ? 20 : 0,
                    right : options.horizontal ? 40 : 0,
                }
            },
            plugins: {
                legend      : { display: isMultiColor, position: 'bottom' },
                datalabels  : datalabelsConfig,
            },
            scales: isMultiColor ? {} : {
                x: {
                    grid  : { display: false },
                    ticks : { font: { size: 10 }, maxTicksLimit: options.maxTicks || 20 }
                },
                y: {
                    beginAtZero : true,
                    ticks       : {
                        font     : { size: 10 },
                        stepSize : options.stepSize || undefined
                    }
                }
            }
        }
    });
}

// â”€â”€ Carga principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarDatos() {
    const inicio = document.getElementById('fechaInicio').value;
    const fin    = document.getElementById('fechaFin').value;

    document.getElementById('loadingIndicator').classList.remove('hidden');

    try {
        const res  = await fetch(`${API_URL}?inicio=${inicio}&fin=${fin}`);
        const data = await res.json();

        // KPIs
        document.getElementById('kpiVigentes').innerText    = data.kpi_vigentes;
        document.getElementById('kpiHistorico').innerText   = data.kpi_historico;
        document.getElementById('kpiSinContacto').innerText = data.kpi_sin_contacto;

        // GrÃ¡ficos temporales
        upsertChart('chartDotacion', 'line',
            data.dotacion.labels, data.dotacion.values,
            'Personas activas',
            { color: '#6366F1', fill: true, maxTicks: 12 }
        );
        upsertChart('chartContrataciones', 'bar',
            data.contrataciones.labels, data.contrataciones.values,
            'Nuevas contrataciones',
            { color: '#10B981', stepSize: 1, maxTicks: 12 }
        );

        // DemogrÃ¡ficos
        upsertChart('chartSexo',         'doughnut', data.sexo.labels,         data.sexo.values,         'GÃ©nero');
        upsertChart('chartEdad',         'bar',      data.edad.labels,          data.edad.values,          'Colaboradores', { color: '#8B5CF6' });
        upsertChart('chartEscolaridad',  'bar',      data.escolaridad.labels,   data.escolaridad.values,   'Personas',      { color: '#F59E0B', horizontal: true });
        upsertChart('chartNacionalidad', 'pie',      data.nacionalidad.labels,  data.nacionalidad.values,  'Nacionalidad');
        upsertChart('chartPermanencia',  'bar',      data.permanencia.labels,   data.permanencia.values,   'Personas',      { color: '#3B82F6' });
        upsertChart('chartComuna',       'bar',      data.comuna.labels,        data.comuna.values,        'Residencia',    { color: '#10B981', horizontal: true });
        upsertChart('chartTipoContrato', 'doughnut', data.tipo_contrato.labels, data.tipo_contrato.values, 'Contrato');

    } catch(e) {
        console.error('Error cargando KPIs:', e);
    } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }
}

document.addEventListener('DOMContentLoaded', cargarDatos);
</script>

{% endblock %}
{% extends 'core/base.html' %}

{% block title %}Control de Accesos{% endblock %}
{% block header_title %}Control de Accesos{% endblock %}

{% block content %}

<!-- â”€â”€ Alerta bloqueado (oculta por defecto) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="alertaBloqueado" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70">
    <div class="bg-white rounded-2xl shadow-2xl border-t-8 border-red-600 max-w-md w-full mx-4 p-8 text-center">
        <div class="text-6xl mb-4">ğŸš«</div>
        <h2 class="text-2xl font-black text-red-600 mb-2">ACCESO DENEGADO</h2>
        <p class="text-slate-700 font-bold text-lg mb-1" id="alertaNombre"></p>
        <p class="text-slate-500 text-sm mb-6">Esta persona tiene una restricciÃ³n de ingreso.<br>Debe ser <strong>atendida fuera de las instalaciones.</strong></p>
        <button onclick="cerrarAlerta()"
            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition">
            Entendido
        </button>
    </div>
</div>

<!-- â”€â”€ Alerta finiquitado (oculta por defecto) â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="alertaFiniquitado" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70">
    <div class="bg-white rounded-2xl shadow-2xl border-t-8 border-yellow-500 max-w-md w-full mx-4 p-8 text-center">
        <div class="text-6xl mb-4">âš ï¸</div>
        <h2 class="text-2xl font-black text-yellow-600 mb-2">PERSONA FINIQUITADA</h2>
        <p class="text-slate-700 font-bold text-lg mb-1" id="alertaFinNombre"></p>
        <p class="text-slate-500 text-sm mb-6">Esta persona ya no pertenece a la dotaciÃ³n activa.<br>Puede ingresar pero debe ser supervisada.</p>
        <button onclick="cerrarAlertaFin()"
            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl transition">
            Continuar registro
        </button>
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

    <!-- â”€â”€ Formulario registro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="xl:col-span-1">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-800 px-6 py-4">
                <h2 class="text-white font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-door-open text-yellow-400"></i> Nuevo Ingreso
                </h2>
            </div>

            <form method="post" class="p-6 space-y-4" id="formIngreso">
                {% csrf_token %}

                <!-- RUT con bÃºsqueda en vivo -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">RUT *</label>
                    <div class="relative">
                        <input type="text" name="rut" id="inputRut" placeholder="Ej: 12.345.678-9"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition"
                            autocomplete="off" required>
                        <span id="rutSpinner" class="hidden absolute right-3 top-2.5 text-slate-400">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <!-- Badge de estado -->
                    <div id="estadoBadge" class="hidden mt-2 flex items-center gap-2 text-sm font-bold px-3 py-2 rounded-lg"></div>
                </div>

                <!-- Nombre (se autocompleta si estÃ¡ en dotaciÃ³n) -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Nombre Completo *</label>
                    <input type="text" name="nombre" id="inputNombre"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition"
                        required>
                </div>

                <!-- Input oculto para estado dotaciÃ³n -->
                <input type="hidden" name="estado_dotacion" id="inputEstadoDotacion" value="EXTERNO">

                <!-- Empresa -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Empresa</label>
                    <input type="text" name="empresa" id="inputEmpresa"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition">
                </div>

                <!-- Patente -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Patente VehÃ­culo</label>
                    <input type="text" name="patente" placeholder="Ej: ABCD12"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition uppercase">
                </div>

                <hr class="border-slate-100">

                <!-- QuiÃ©n autoriza -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">QuiÃ©n Autoriza *</label>
                    <input type="text" name="quien_autoriza"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition"
                        required>
                </div>

                <!-- A quiÃ©n visita -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">A QuiÃ©n Visita *</label>
                    <input type="text" name="a_quien_visita"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition"
                        required>
                </div>

                <!-- Lugar -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Lugar *</label>
                    <input type="text" name="lugar" placeholder="Ej: Sala reuniones, Gerencia..."
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition"
                        required>
                </div>

                <!-- NÂº tarjeta -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">NÂº Tarjeta de Visita</label>
                    <input type="text" name="numero_tarjeta" placeholder="Ej: 042"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 outline-none transition">
                </div>

                <button type="submit" id="btnRegistrar"
                    class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-right-to-bracket"></i> Registrar Ingreso
                </button>
            </form>
        </div>
    </div>

    <!-- â”€â”€ Panel derecho: adentro + historial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="xl:col-span-2 space-y-6">

        <!-- Personas adentro ahora -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <span class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse inline-block"></span>
                    Personas dentro ahora
                    <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">
                        {{ adentro.count }}
                    </span>
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="tablaAdentro">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr>
                            <th class="p-3 text-left">Nombre</th>
                            <th class="p-3 text-left">RUT</th>
                            <th class="p-3 text-left">Empresa</th>
                            <th class="p-3 text-left">Visita a</th>
                            <th class="p-3 text-left">Lugar</th>
                            <th class="p-3 text-center">Tarjeta</th>
                            <th class="p-3 text-center">Entrada</th>
                            <th class="p-3 text-center">Salida</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in adentro %}
                        <tr class="border-t hover:bg-slate-50 transition" id="fila-{{ r.pk }}">
                            <td class="p-3 font-bold">
                                {% if r.estado_dotacion == 'BLOQUEADO' %}
                                    <span class="text-red-600">ğŸ”´ {{ r.nombre }}</span>
                                {% elif r.estado_dotacion == 'FINIQUITADO' %}
                                    <span class="text-yellow-600">ğŸŸ¡ {{ r.nombre }}</span>
                                {% else %}
                                    {{ r.nombre }}
                                {% endif %}
                            </td>
                            <td class="p-3 text-slate-500">{{ r.rut }}</td>
                            <td class="p-3 text-slate-500">{{ r.empresa|default:"â€”" }}</td>
                            <td class="p-3">{{ r.a_quien_visita }}</td>
                            <td class="p-3 text-slate-500">{{ r.lugar }}</td>
                            <td class="p-3 text-center">
                                {% if r.numero_tarjeta %}
                                    <span class="bg-slate-100 px-2 py-0.5 rounded font-bold text-xs">{{ r.numero_tarjeta }}</span>
                                {% else %}â€”{% endif %}
                            </td>
                            <td class="p-3 text-center text-slate-500 whitespace-nowrap">{{ r.hora_entrada|date:"H:i" }}</td>
                            <td class="p-3 text-center">
                                <button onclick="registrarSalida({{ r.pk }}, this)"
                                    class="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-1 rounded-lg text-xs font-bold transition">
                                    <i class="fa-solid fa-right-from-bracket"></i> Salida
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="p-8 text-center text-slate-400 text-sm">
                                No hay personas registradas adentro.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Historial del dÃ­a -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="px-6 py-4 border-b border-slate-100">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-slate-400"></i>
                    Historial de hoy
                    <span class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full">
                        {{ historial.count }}
                    </span>
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr>
                            <th class="p-3 text-left">Nombre</th>
                            <th class="p-3 text-left">RUT</th>
                            <th class="p-3 text-left">Empresa</th>
                            <th class="p-3 text-center">Entrada</th>
                            <th class="p-3 text-center">Salida</th>
                            <th class="p-3 text-center">DuraciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in historial %}
                        <tr class="border-t hover:bg-slate-50 transition text-slate-600">
                            <td class="p-3">{{ r.nombre }}</td>
                            <td class="p-3 text-slate-400">{{ r.rut }}</td>
                            <td class="p-3 text-slate-400">{{ r.empresa|default:"â€”" }}</td>
                            <td class="p-3 text-center">{{ r.hora_entrada|date:"H:i" }}</td>
                            <td class="p-3 text-center">{{ r.hora_salida|date:"H:i" }}</td>
                            <td class="p-3 text-center">
                                <span class="bg-slate-100 px-2 py-0.5 rounded text-xs font-bold">{{ r.duracion }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="p-8 text-center text-slate-400 text-sm">
                                Sin salidas registradas hoy.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
const API_BUSCAR  = "{% url 'accesos_api_buscar' %}";
const API_SALIDA  = (pk) => `/accesos/api/salida/${pk}/`;
const CSRF        = '{{ csrf_token }}';

let estadoActual  = 'EXTERNO';
let busquedaTimer = null;

// â”€â”€ Formato RUT chileno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatearRut(rut) {
    let limpio = rut.replace(/[^0-9kK]/g, '').toUpperCase();
    if (limpio.length < 2) return limpio;
    const dv     = limpio.slice(-1);
    const cuerpo = limpio.slice(0, -1);
    const formateado = parseInt(cuerpo, 10).toLocaleString('es-CL').replace(/\./g, '.');
    return `${formateado}-${dv}`;
}

// â”€â”€ ValidaciÃ³n mÃ³dulo 11 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validarRut(rut) {
    const limpio = rut.replace(/[^0-9kK]/g, '').toUpperCase();
    if (limpio.length < 2) return false;
    const dv     = limpio.slice(-1);
    const cuerpo = limpio.slice(0, -1);
    let suma = 0, multiplo = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma      += parseInt(cuerpo[i]) * multiplo;
        multiplo   = multiplo < 7 ? multiplo + 1 : 2;
    }
    const dvEsperado = 11 - (suma % 11);
    const dvCalc     = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : String(dvEsperado);
    return dv === dvCalc;
}

// â”€â”€ Input RUT: formateo en tiempo real â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const inputRut = document.getElementById('inputRut');
inputRut.addEventListener('input', function () {
    clearTimeout(busquedaTimer);
    const raw = this.value.replace(/[^0-9kK]/g, '');
    if (raw.length > 1) {
        this.value = formatearRut(raw);
    }
    const rut = this.value.trim();

    // Limpiar si muy corto
    if (raw.length < 7) { limpiarBadge(); return; }

    // Validar mÃ³dulo 11
    if (!validarRut(rut)) {
        mostrarBadgeError('RUT invÃ¡lido');
        return;
    }

    document.getElementById('rutSpinner').classList.remove('hidden');
    busquedaTimer = setTimeout(() => buscarRut(rut), 500);
});

async function buscarRut(rut) {
    try {
        const res  = await fetch(`${API_BUSCAR}?rut=${encodeURIComponent(rut)}`);
        const data = await res.json();
        document.getElementById('rutSpinner').classList.add('hidden');

        estadoActual = data.estado || 'EXTERNO';
        document.getElementById('inputEstadoDotacion').value = estadoActual;

        if (data.encontrado) {
            document.getElementById('inputNombre').value  = data.nombre;
            document.getElementById('inputEmpresa').value = data.empresa;
            mostrarBadge(estadoActual, data.cargo);
            if (estadoActual === 'BLOQUEADO')   mostrarAlertaBloqueado(data.nombre);
            if (estadoActual === 'FINIQUITADO') mostrarAlertaFiniquitado(data.nombre);
        } else {
            limpiarBadge();
            mostrarBadge('EXTERNO', '');
        }
    } catch(e) {
        document.getElementById('rutSpinner').classList.add('hidden');
    }
}

// â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarBadge(estado, cargo) {
    const badge = document.getElementById('estadoBadge');
    const config = {
        'VIGENTE'    : { color: 'bg-green-50 text-green-700 border border-green-200',    icon: 'âœ…', texto: `Vigente â€” ${cargo}` },
        'FINIQUITADO': { color: 'bg-yellow-50 text-yellow-700 border border-yellow-200', icon: 'âš ï¸', texto: 'Finiquitado' },
        'BLOQUEADO'  : { color: 'bg-red-50 text-red-700 border border-red-200',          icon: 'ğŸš«', texto: 'BLOQUEADO â€” No puede ingresar' },
        'EXTERNO'    : { color: 'bg-slate-50 text-slate-600 border border-slate-200',    icon: 'ğŸ‘¤', texto: 'Externo / No encontrado en dotaciÃ³n' },
    };
    const c = config[estado] || config['EXTERNO'];
    badge.className = `mt-2 flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg ${c.color}`;
    badge.innerHTML = `${c.icon} ${c.texto}`;
    badge.classList.remove('hidden');
    habilitarFormulario();
}

function mostrarBadgeError(msg) {
    const badge = document.getElementById('estadoBadge');
    badge.className = 'mt-2 flex items-center gap-2 text-xs font-bold px-3 py-2 rounded-lg bg-red-50 text-red-600 border border-red-200';
    badge.innerHTML = `âŒ ${msg}`;
    badge.classList.remove('hidden');
}

function limpiarBadge() {
    document.getElementById('estadoBadge').classList.add('hidden');
    document.getElementById('inputNombre').value  = '';
    document.getElementById('inputEmpresa').value = '';
    estadoActual = 'EXTERNO';
    document.getElementById('inputEstadoDotacion').value = 'EXTERNO';
    habilitarFormulario();
}

// â”€â”€ Alertas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarAlertaBloqueado(nombre) {
    document.getElementById('alertaNombre').innerText = nombre;
    document.getElementById('alertaBloqueado').classList.remove('hidden');
    bloquearFormulario();
}
function mostrarAlertaFiniquitado(nombre) {
    document.getElementById('alertaFinNombre').innerText = nombre;
    document.getElementById('alertaFiniquitado').classList.remove('hidden');
}
function cerrarAlerta() {
    document.getElementById('alertaBloqueado').classList.add('hidden');
    document.getElementById('formIngreso').reset();
    limpiarBadge();
}
function cerrarAlertaFin() {
    document.getElementById('alertaFiniquitado').classList.add('hidden');
}

function bloquearFormulario() {
    const btn = document.getElementById('btnRegistrar');
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
}
function habilitarFormulario() {
    const btn = document.getElementById('btnRegistrar');
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
}

// â”€â”€ Submit por AJAX (sin recargar pÃ¡gina) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('formIngreso').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('btnRegistrar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';

    const formData = new FormData(this);

    const res  = await fetch('', { method: 'POST', body: formData });
    const html = await res.text();

    // Parsea la respuesta y extrae las tablas actualizadas
    const parser   = new DOMParser();
    const doc      = parser.parseFromString(html, 'text/html');
    const nuevaTablaAdentro = doc.getElementById('tablaAdentro');
    if (nuevaTablaAdentro) {
        document.getElementById('tablaAdentro').innerHTML = nuevaTablaAdentro.innerHTML;
    }

    // Limpia el formulario
    this.reset();
    limpiarBadge();
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Registrar Ingreso';
});

// â”€â”€ Registrar salida sin recargar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registrarSalida(pk, btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    const res  = await fetch(API_SALIDA(pk), {
        method : 'POST',
        headers: { 'X-CSRFToken': CSRF }
    });
    const data = await res.json();

    if (data.ok) {
        const fila = document.getElementById(`fila-${pk}`);
        fila.style.transition = 'opacity 0.3s';
        fila.style.opacity    = '0';
        setTimeout(() => fila.remove(), 300);
    } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Salida';
    }
}
</script>

{% endblock %}